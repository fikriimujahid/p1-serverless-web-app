name: IaC Security Scan

on:
  pull_request:
    branches: [dev, main]
    paths: ['infra/**']
  push:
    branches: [dev, main]
    paths: ['infra/**']

jobs:
  checkov:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Checkov on Terraform
        uses: bridgecrewio/checkov-action@master
        with:
          directory: infra/terraform
          framework: terraform
          output_format: cli
          soft_fail: false
          skip_check: CKV_AWS_18,CKV_AWS_144  # Adjust based on your needs
      
      - name: Run Checkov on SAM Template
        uses: bridgecrewio/checkov-action@master
        with:
          file: backend/template.yaml
          framework: cloudformation
          output_format: cli
          soft_fail: false

  tfsec:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: infra/terraform
          soft_fail: false
          
  terrascan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Terrascan
        uses: tenable/terrascan-action@main
        with:
          iac_type: terraform
          iac_dir: infra/terraform
          policy_type: aws
          only_warn: false
