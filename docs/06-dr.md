# 06 — Disaster Recovery (DR)

This guide defines backup scope, practical restore steps, and RPO/RTO goals for the system.

---

## 1) Backup Scope

Identify what must be recoverable and where it lives.

- DynamoDB: Notes data (primary store)
- S3: Frontend static assets and any artifact buckets
- CloudFront: Distribution configuration (reprovision via IaC)
- Lambda/API Gateway: Rebuild via CI/CD and IaC
- Terraform state: S3 bucket + DynamoDB lock table
- CI/CD workflows: GitHub repo (versioned)

Controls
- DynamoDB: Enable Point-In-Time Recovery (PITR)
- S3: Default encryption; versioning for critical buckets
- Terraform: Bucket is private, encrypted, with lifecycle policies

---

## 2) Restore Steps

Practical sequence to recover service in the same region.

1. Validate blast radius
   - Confirm what’s lost (data vs. infra)
   - Review CloudWatch alarms and logs

2. Restore data (DynamoDB)

```powershell
# Example AWS CLI restore (adjust names)
aws dynamodb restore-table-to-point-in-time `
  --source-table-name Notes `
  --target-table-name Notes-Restore `
  --restore-date-time 2025-12-21T10:00:00Z

# Optionally swap names or update app config to point to restored table
```

3. Rebuild infra via IaC

```powershell
# Terraform re-init & apply (environment-specific)
cd infra/terraform/environments/dev
terraform init --backend-config=backend.hcl
terraform apply -auto-approve
```

4. Re-deploy backend

```powershell
cd backend
npm ci
npm run sam:deploy
```

5. Re-deploy frontend

```powershell
cd frontend
npm ci
npm run build
# Sync build output to S3 (use your deploy script or CI)
```

6. Invalidate CDN cache

```powershell
aws cloudfront create-invalidation `
  --distribution-id E123ABC456 `
  --paths "/*"
```

7. Verification
   - Health-check endpoints via API Gateway
   - Confirm auth and note CRUD works end-to-end

---

## 3) RPO/RTO

Definitions
- RPO (Recovery Point Objective): Max acceptable data loss window
- RTO (Recovery Time Objective): Max acceptable time to restore service

Targets (example; tune to your needs)
- RPO: 15 minutes (via DynamoDB PITR)
- RTO: 60 minutes (IaC + automated redeploy)

Achievability
- RPO is bounded by PITR granularity and operator choice
- RTO depends on infra size, CI speed, and validation steps

---

## Runbooks & Ownership

- Keep a short runbook in `docs/07-incident.md` to link DR actions
- Assign DR owner(s) and rotate rehearsals quarterly
